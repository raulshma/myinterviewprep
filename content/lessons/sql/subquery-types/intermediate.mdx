# Subquery Types: Practical Usage

Apply each subquery type effectively in real scenarios.

## Scalar Subqueries in Detail

```sql
-- Multiple scalars in SELECT
SELECT
    name,
    price,
    (SELECT MIN(price) FROM products) AS min_price,
    (SELECT MAX(price) FROM products) AS max_price,
    (SELECT AVG(price) FROM products) AS avg_price,
    price - (SELECT AVG(price) FROM products) AS diff_from_avg
FROM products;

-- Scalar in CASE
SELECT *,
    CASE
        WHEN price > (SELECT AVG(price) FROM products) THEN 'Above Average'
        ELSE 'Below Average'
    END AS price_category
FROM products;
```

## Column Subqueries Patterns

```sql
-- IN with filtering
SELECT * FROM customers
WHERE id IN (
    SELECT customer_id FROM orders
    WHERE total > 100
    AND order_date > '2024-01-01'
);

-- NOT IN gotcha with NULLs
-- If subquery returns any NULL, NOT IN returns no rows!
SELECT * FROM products
WHERE id NOT IN (
    SELECT product_id FROM order_items
    WHERE product_id IS NOT NULL  -- IMPORTANT!
);

-- Safer: Use NOT EXISTS
WHERE NOT EXISTS (SELECT 1 FROM order_items WHERE product_id = p.id)
```

## Table Subqueries as Derived Tables

```sql
-- Pre-aggregate then filter
SELECT * FROM (
    SELECT
        customer_id,
        COUNT(*) AS order_count,
        SUM(total) AS total_spent,
        AVG(total) AS avg_order
    FROM orders
    GROUP BY customer_id
) customer_stats
WHERE order_count >= 5 AND avg_order > 50;

-- Combine with outer table
SELECT c.name, s.order_count, s.total_spent
FROM customers c
JOIN (
    SELECT customer_id, COUNT(*) AS order_count, SUM(total) AS total_spent
    FROM orders
    GROUP BY customer_id
) s ON c.id = s.customer_id
ORDER BY s.total_spent DESC;
```

## Converting Between Types

```sql
-- Column to Scalar with aggregate
SELECT * FROM products
WHERE price > (SELECT MAX(price) * 0.5 FROM products);  -- Scalar

-- Table to Scalar with aggregate
SELECT * FROM products
WHERE price > (
    SELECT avg_price FROM (
        SELECT category, AVG(price) AS avg_price
        FROM products GROUP BY category
    ) t WHERE category = 'Electronics'
);
```

## CTEs as Named Subqueries

```sql
-- Multiple reusable "subqueries"
WITH
customer_orders AS (
    SELECT customer_id, COUNT(*) AS cnt, SUM(total) AS total
    FROM orders GROUP BY customer_id
),
vip_customers AS (
    SELECT customer_id FROM customer_orders WHERE total > 1000
)
SELECT c.*, co.cnt, co.total
FROM customers c
JOIN customer_orders co ON c.id = co.customer_id
WHERE c.id IN (SELECT customer_id FROM vip_customers);
```

## Inline vs Materialized

```sql
-- Optimizer decides whether to:
-- 1. Inline: Merge subquery into main query
-- 2. Materialize: Execute once, store result

-- Hint to materialize (SQL Server 2019+)
SELECT * FROM (
    SELECT category, AVG(price) AS avg_price
    FROM products GROUP BY category
) AS t OPTION (USE HINT('FORCE_LEGACY_CARDINALITY_ESTIMATION'));
```

<ProgressCheckpoint section="subquery-types-complete" xpReward={35} />
