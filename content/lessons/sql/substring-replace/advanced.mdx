# SUBSTRING and REPLACE: Expert Topics

Regex, performance, and complex parsing.

## Regular Expressions

```sql
-- PostgreSQL: Full regex support
SELECT SUBSTRING('abc123def' FROM '[0-9]+');  -- '123'
SELECT REGEXP_REPLACE('abc123def', '[0-9]+', 'X');  -- 'abcXdef'

-- MySQL: REGEXP_SUBSTR, REGEXP_REPLACE
SELECT REGEXP_SUBSTR('abc123def', '[0-9]+');  -- '123'

-- SQL Server: Limited pattern matching
-- Use CLR functions for full regex
```

## Performance Optimization

```sql
-- String functions prevent index usage
-- Slow:
WHERE SUBSTRING(code, 1, 3) = 'ABC'

-- Fast: Use LIKE with prefix
WHERE code LIKE 'ABC%'

-- For computed values, use persisted column
ALTER TABLE products ADD code_prefix AS LEFT(code, 3) PERSISTED;
CREATE INDEX IX_code_prefix ON products(code_prefix);
```

## Parsing Complex Formats

```sql
-- Parse URL components
WITH parsed AS (
    SELECT
        url,
        SUBSTRING(url,
            CHARINDEX('://', url) + 3,
            CASE
                WHEN CHARINDEX('/', url, CHARINDEX('://', url) + 3) > 0
                THEN CHARINDEX('/', url, CHARINDEX('://', url) + 3) - CHARINDEX('://', url) - 3
                ELSE LEN(url)
            END
        ) AS host
    FROM urls
)
SELECT * FROM parsed;
```

## Recursive String Manipulation

```sql
-- Split string into rows (pre-STRING_SPLIT)
WITH RECURSIVE splitter AS (
    SELECT
        1 AS item_num,
        CASE WHEN CHARINDEX(',', value) > 0
             THEN LEFT(value, CHARINDEX(',', value) - 1)
             ELSE value END AS item,
        CASE WHEN CHARINDEX(',', value) > 0
             THEN SUBSTRING(value, CHARINDEX(',', value) + 1, LEN(value))
             ELSE NULL END AS remainder
    FROM (SELECT 'a,b,c,d' AS value) src

    UNION ALL

    SELECT
        item_num + 1,
        CASE WHEN CHARINDEX(',', remainder) > 0
             THEN LEFT(remainder, CHARINDEX(',', remainder) - 1)
             ELSE remainder END,
        CASE WHEN CHARINDEX(',', remainder) > 0
             THEN SUBSTRING(remainder, CHARINDEX(',', remainder) + 1, LEN(remainder))
             ELSE NULL END
    FROM splitter
    WHERE remainder IS NOT NULL
)
SELECT item_num, item FROM splitter;
```

## STRING_SPLIT (Modern Approach)

```sql
-- SQL Server 2016+, PostgreSQL 14+
SELECT value FROM STRING_SPLIT('a,b,c,d', ',');

-- With ordinal (SQL Server 2022+)
SELECT value, ordinal FROM STRING_SPLIT('a,b,c,d', ',', 1);

-- PostgreSQL: regexp_split_to_table
SELECT regexp_split_to_table('a,b,c,d', ',');
```

## Binary/Hex Manipulation

```sql
-- Convert to hex representation
SELECT CONVERT(VARCHAR(MAX), HASHBYTES('SHA2_256', 'password'), 2);

-- Extract bytes
SELECT SUBSTRING(CAST(binary_col AS VARBINARY(MAX)), 1, 4);
```

<StringFunctionPlayground mode="advanced" />

<ProgressCheckpoint section="substring-replace-advanced" xpReward={50} />
