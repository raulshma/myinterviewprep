# Nested Subqueries: Practical Applications

Master subquery patterns for real-world scenarios.

## Scalar Subqueries

Return a single value:

```sql
SELECT
    employee_name,
    salary,
    (SELECT AVG(salary) FROM employees) AS company_avg,
    salary - (SELECT AVG(salary) FROM employees) AS diff_from_avg,
    (SELECT MAX(salary) FROM employees WHERE department = e.department) AS dept_max
FROM employees e;
```

## Multi-Row Subqueries

Return multiple values with IN/NOT IN:

```sql
-- Products in popular categories
SELECT * FROM products
WHERE category_id IN (
    SELECT id FROM categories WHERE popularity > 'High'
);

-- Orders from active customers
SELECT * FROM orders
WHERE customer_id IN (
    SELECT id FROM customers WHERE is_active = 1
);
```

## Multi-Level Nesting

```sql
-- Products in categories that have bestsellers
SELECT * FROM products
WHERE category_id IN (
    SELECT category_id FROM products
    WHERE id IN (
        SELECT product_id FROM bestsellers
    )
);
```

## Subquery with ANY/ALL

```sql
-- Price greater than any budget product
SELECT * FROM products
WHERE price > ANY (
    SELECT price FROM products WHERE category = 'Budget'
);

-- Price greater than all budget products
SELECT * FROM products
WHERE price > ALL (
    SELECT price FROM products WHERE category = 'Budget'
);
```

## Derived Tables

```sql
-- Join with subquery result
SELECT c.name, os.order_count, os.total_spent
FROM customers c
JOIN (
    SELECT
        customer_id,
        COUNT(*) AS order_count,
        SUM(total) AS total_spent
    FROM orders
    GROUP BY customer_id
) os ON c.id = os.customer_id;
```

## Common Table Expressions (CTE)

More readable alternative to nested subqueries:

```sql
-- Instead of nested subquery
WITH high_value_orders AS (
    SELECT customer_id FROM orders
    GROUP BY customer_id
    HAVING SUM(total) > 1000
)
SELECT * FROM customers
WHERE id IN (SELECT customer_id FROM high_value_orders);

-- Multiple CTEs
WITH
order_stats AS (
    SELECT customer_id, SUM(total) AS total
    FROM orders GROUP BY customer_id
),
top_customers AS (
    SELECT customer_id FROM order_stats WHERE total > 1000
)
SELECT * FROM customers WHERE id IN (SELECT customer_id FROM top_customers);
```

## Subquery Performance

```sql
-- Subquery executed once (scalar)
SELECT * FROM products WHERE price > (SELECT AVG(price) FROM products);

-- Subquery may execute many times (with outer reference)
-- Consider JOIN for better performance
```

<ProgressCheckpoint section="nested-practical" xpReward={45} />
