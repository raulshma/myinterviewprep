# GROUP BY and HAVING: Practical Patterns

Master grouping and aggregation for real analytics queries.

## Multi-Column Grouping

```sql
-- Group by multiple columns
SELECT
    YEAR(order_date) AS year,
    MONTH(order_date) AS month,
    COUNT(*) AS order_count,
    SUM(total) AS revenue
FROM orders
GROUP BY YEAR(order_date), MONTH(order_date)
ORDER BY year, month;
```

## Aggregate Functions Deep Dive

```sql
SELECT
    category,
    COUNT(*) AS total_products,
    COUNT(discount) AS products_with_discount,  -- Counts non-NULL only
    SUM(price) AS total_value,
    AVG(price) AS avg_price,
    MIN(price) AS min_price,
    MAX(price) AS max_price,
    -- String aggregation (SQL Server 2017+)
    STRING_AGG(product_name, ', ') AS product_list
FROM products
GROUP BY category;
```

### DISTINCT in Aggregates

```sql
SELECT
    order_id,
    COUNT(*) AS total_items,
    COUNT(DISTINCT product_id) AS unique_products,
    SUM(quantity) AS total_quantity
FROM order_items
GROUP BY order_id;
```

## Complex HAVING Conditions

```sql
SELECT
    customer_id,
    COUNT(*) AS order_count,
    SUM(total) AS total_spent,
    AVG(total) AS avg_order
FROM orders
GROUP BY customer_id
HAVING
    COUNT(*) >= 5
    AND SUM(total) > 1000
    AND AVG(total) > 50
ORDER BY total_spent DESC;
```

## Grouping with JOINs

```sql
SELECT
    c.category_name,
    COUNT(p.id) AS product_count,
    AVG(p.price) AS avg_price,
    SUM(oi.quantity) AS total_sold
FROM categories c
LEFT JOIN products p ON c.id = p.category_id
LEFT JOIN order_items oi ON p.id = oi.product_id
GROUP BY c.category_name
ORDER BY total_sold DESC;
```

## Conditional Aggregation

```sql
SELECT
    YEAR(order_date) AS year,
    COUNT(*) AS total_orders,
    SUM(CASE WHEN status = 'completed' THEN 1 ELSE 0 END) AS completed,
    SUM(CASE WHEN status = 'cancelled' THEN 1 ELSE 0 END) AS cancelled,
    SUM(CASE WHEN status = 'completed' THEN total ELSE 0 END) AS completed_revenue
FROM orders
GROUP BY YEAR(order_date);
```

## Grouping Sets

```sql
-- Multiple levels of aggregation in one query
SELECT
    category,
    brand,
    SUM(sales) AS total_sales
FROM products
GROUP BY GROUPING SETS (
    (category, brand),  -- By category and brand
    (category),         -- By category only
    ()                  -- Grand total
);
```

## NULL in GROUP BY

```sql
-- NULLs form their own group
SELECT category, COUNT(*)
FROM products
GROUP BY category;  -- NULL category is one group

-- Filter out NULLs if needed
WHERE category IS NOT NULL
```

<ProgressCheckpoint section="groupby-having-intermediate" xpReward={45} />
