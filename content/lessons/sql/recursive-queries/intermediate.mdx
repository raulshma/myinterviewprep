# Recursive Queries: Practical Patterns

Real-world recursive CTE applications.

## Organization Chart with Path

```sql
WITH RECURSIVE org AS (
    SELECT id, name, manager_id,
           CAST(name AS VARCHAR(1000)) AS path,
           1 AS depth
    FROM employees WHERE manager_id IS NULL

    UNION ALL

    SELECT e.id, e.name, e.manager_id,
           CAST(o.path + ' > ' + e.name AS VARCHAR(1000)),
           o.depth + 1
    FROM employees e
    JOIN org o ON e.manager_id = o.id
)
SELECT name, path, depth FROM org ORDER BY path;

-- Result:
-- CEO, CEO, 1
-- CFO, CEO > CFO, 2
-- Accountant, CEO > CFO > Accountant, 3
```

## Bill of Materials

```sql
-- Product parts hierarchy
WITH RECURSIVE bom AS (
    SELECT product_id, part_id, quantity, 1 AS level
    FROM product_parts WHERE product_id = 100

    UNION ALL

    SELECT b.product_id, pp.part_id, b.quantity * pp.quantity, b.level + 1
    FROM bom b
    JOIN product_parts pp ON b.part_id = pp.product_id
)
SELECT part_id, SUM(quantity) AS total_needed
FROM bom
GROUP BY part_id;
```

## Category Breadcrumbs

```sql
WITH RECURSIVE breadcrumb AS (
    SELECT id, name, parent_id, CAST(name AS VARCHAR(500)) AS crumb
    FROM categories WHERE id = 42  -- Start from current category

    UNION ALL

    SELECT c.id, c.name, c.parent_id, CAST(c.name + ' > ' + b.crumb AS VARCHAR(500))
    FROM categories c
    JOIN breadcrumb b ON c.id = b.parent_id
)
SELECT crumb FROM breadcrumb WHERE parent_id IS NULL;
-- Home > Electronics > Phones > iPhone
```

## Date Range Generation

```sql
WITH RECURSIVE dates AS (
    SELECT CAST('2024-01-01' AS DATE) AS dt

    UNION ALL

    SELECT DATEADD(DAY, 1, dt)
    FROM dates
    WHERE dt < '2024-01-31'
)
SELECT dt FROM dates;
```

## Finding All Descendants

```sql
WITH RECURSIVE descendants AS (
    SELECT id FROM employees WHERE id = 5  -- Manager ID

    UNION ALL

    SELECT e.id
    FROM employees e
    JOIN descendants d ON e.manager_id = d.id
)
SELECT * FROM employees WHERE id IN (SELECT id FROM descendants);
```

## Ancestor Chain

```sql
WITH RECURSIVE ancestors AS (
    SELECT id, name, manager_id FROM employees WHERE id = 42

    UNION ALL

    SELECT e.id, e.name, e.manager_id
    FROM employees e
    JOIN ancestors a ON a.manager_id = e.id
)
SELECT * FROM ancestors;
```

<ProgressCheckpoint section="recursive-queries-complete" xpReward={45} />
